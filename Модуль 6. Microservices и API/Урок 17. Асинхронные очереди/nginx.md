### Глобальные настройки

- **Пользователь и процессы:**  
  - `user nginx;` – Nginx запускается от имени пользователя **nginx**.  
  - `worker_processes 1;` – используется один рабочий процесс, что подходит для небольших нагрузок или тестирования.

- **Секция `events`:**  
  - `worker_connections 1024;` – каждый рабочий процесс может обрабатывать до 1024 одновременных соединений.

---

### HTTP-блок и сервер

- **Секция `http`:** Здесь происходит настройка HTTP-сервера.  
- **Секция `server`:**  
  - `listen 80;` – сервер принимает запросы на 80-м порту (стандартный HTTP-порт).  
  - `server_name localhost;` – сервер отвечает на запросы, адресованные к `localhost`.

---

### Маршрутизация запросов через локации

#### 1. Локация `/auth/verify` – проверка токена

- **Назначение:**  
  Используется для внутренней проверки токена (авторизации) перед проксированием запросов.

- **Директивы:**  
  - `internal;` – эта локация доступна **только** для внутренних запросов Nginx (не может быть вызвана напрямую извне).  
  - `proxy_pass http://auth_service:8003/auth/auth/verify;` – запрос перенаправляется на микросервис авторизации, работающий на порту 8003, по адресу `/auth/auth/verify`.  
  - **Передача заголовков:**  
    - `proxy_set_header Host $host;` – передаётся исходное имя хоста.  
    - `proxy_set_header X-Real-IP $remote_addr;` – передаётся IP-адрес клиента.  
    - `proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;` – добавляет IP-адреса из цепочки прокси.

#### 2. Локация `/auth/` – сервис авторизации

- **Назначение:**  
  Обрабатывает запросы, связанные с авторизацией.

- **Директивы:**  
  - `proxy_pass http://auth_service:8003/;` – все запросы, начинающиеся с `/auth/`, проксируются на тот же сервис авторизации, но без дополнительного пути.  
  - Дополнительный заголовок:  
    - `proxy_set_header X-Forwarded-Prefix /auth;` – передаёт префикс запроса для дальнейшей обработки на стороне сервиса.

#### 3. Локация для `/api/` без проверки авторизации

- **Определение:**  
  Регулярное выражение `~ ^/api/(docs|categories/*|tags/*|openapi\.json)$` выбирает запросы к:
  - `/api/docs`
  - `/api/categories/...` (любой путь после `/categories/`)
  - `/api/tags/...`
  - `/api/openapi.json`

- **Директивы:**  
  - `proxy_pass http://lostfound_service:8000;` – запросы направляются к сервису lostfound, работающему на порту 8000.  
  - Передаются стандартные заголовки для сохранения данных об IP и хосте.

#### 4. Локация для `/api/` с проверкой авторизации

- **Назначение:**  
  Обрабатывает все остальные запросы к `/api/`, для которых требуется предварительная проверка авторизации.

- **Механизм проверки:**  
  - `auth_request /auth/verify;` – перед основным проксированием выполняется внутренний запрос к `/auth/verify` для проверки токена.  
  - `auth_request_set $auth_status $upstream_status;` – результат проверки (HTTP-статус) сохраняется в переменной `$auth_status`.

- **Проксирование запроса:**  
  - `proxy_pass http://lostfound_service:8000/;` – после успешной проверки запрос отправляется на сервис lostfound.  
  - Заголовок `X-Forwarded-Prefix /api` передаётся для информирования бэкенда о префиксе запроса.

- **Обработка ошибок авторизации:**  
  - `error_page 401 = @error401;` и `error_page 403 = @error403;` – в случае ошибок 401 (Unauthorized) или 403 (Forbidden) запрос перенаправляется на специальные локации, где возвращается кастомное JSON-сообщение.

#### 5. Локация для `/auction/` без проверки авторизации (документация)

- **Определение:**  
  Регулярное выражение `~ ^/auction/(docs|openapi\.json)$` выбирает запросы к:
  - `/auction/docs`
  - `/auction/openapi.json`

- **Директивы:**  
  - `proxy_pass http://auction_service:8004;` – запросы направляются к сервису аукционов, работающему на порту 8004.  
  - Передаются стандартные заголовки.

#### 6. Локация для остальных запросов к `/auction/`

- **Назначение:**  
  Обрабатывает все остальные запросы, начинающиеся с `/auction/`.

- **Авторизация (опционально):**  
  - Закомментированные строки с `auth_request` и `auth_request_set` показывают, что можно включить проверку авторизации для этого сервиса. На данный момент авторизация не выполняется.

- **Проксирование запроса:**  
  - `proxy_pass http://auction_service:8004/;` – запрос отправляется к сервису аукционов.  
  - Заголовок `X-Forwarded-Prefix /auction` передаётся для информирования бэкенда о префиксе запроса.

- **Обработка ошибок:**  
  - Как и в случае с `/api/`, здесь прописаны директивы для обработки ошибок 401 и 403.

---

### Обработка ошибок

- **Локация `@error401`:**  
  При возникновении ошибки 401 (Unauthorized) возвращается ответ с HTTP-статусом 401 и JSON-сообщением:
  ```json
  {"error": "Unauthorized"}
  ```

- **Локация `@error403`:**  
  Аналогично, при ошибке 403 (Forbidden) возвращается ответ с HTTP-статусом 403 и JSON-сообщением:
  ```json
  {"error": "Forbidden"}
  ```

Эти специальные локации обеспечивают единообразное и понятное сообщение об ошибке для клиента, если проверка авторизации не пройдена.
